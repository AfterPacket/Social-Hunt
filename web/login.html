<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Login - Social Hunt</title>
        <meta
            http-equiv="Cache-Control"
            content="no-cache, no-store, must-revalidate"
        />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <link rel="stylesheet" href="/static/styles.css?v=2.2.2" />
        <style>
            /* Enhanced theme consistency for login page */
            :root {
                /* Force CSS variables refresh */
                --theme-transition: none;
            }

            body {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
                /* Ensure background uses theme variable */
                background: var(--bg) !important;
                color: var(--text) !important;
                /* Prevent theme transition flicker */
                transition:
                    background-color 0s,
                    color 0s !important;
            }

            .login-wrapper {
                width: 100%;
                max-width: 360px;
            }

            .brand {
                text-align: center;
                margin-bottom: 1.5rem;
                padding: 1.5rem 1rem;
            }

            /* Ensure card uses theme variables */
            .card {
                background: var(--panel) !important;
                border-color: var(--border) !important;
                color: var(--text) !important;
            }

            /* Force theme variable recalculation */
            * {
                /* Trigger repaint for theme consistency */
                transform: translateZ(0);
            }

            /* Theme-specific overrides for login consistency */
            .brand-title {
                color: var(--accent, var(--text)) !important;
            }

            .brand-sub {
                color: var(--muted) !important;
            }

            /* Input styling consistency */
            input[type="password"] {
                background: var(--panel2, var(--panel)) !important;
                border-color: var(--border) !important;
                color: var(--text) !important;
            }

            input[type="password"]:focus {
                border-color: var(--accent) !important;
                box-shadow: 0 0 0 2px
                    rgba(var(--accent-rgb, 140, 200, 255), 0.2) !important;
            }
        </style>
    </head>
    <body>
        <div class="login-wrapper">
            <div class="card">
                <div class="brand">
                    <div class="brand-title" style="font-size: 1.4em">
                        Social Hunt
                    </div>
                    <div class="brand-sub">Self-hosted OSINT aggregator</div>
                </div>

                <form id="loginForm">
                    <div class="row" style="margin-bottom: 1rem">
                        <input
                            type="password"
                            id="token"
                            placeholder="Enter Admin Token"
                            required
                            autofocus
                        />
                    </div>
                    <div id="captchaContainer" style="display:none; margin-bottom: 1rem;">
                        <div id="hcaptchaWidget" class="h-captcha"></div>
                    </div>
                    <button type="submit" class="btn good" style="width: 100%">
                        Sign in
                    </button>
                    <div
                        id="errorMsg"
                        style="
                            color: var(--danger);
                            margin-top: 10px;
                            text-align: center;
                            display: none;
                        "
                    ></div>
                </form>
            </div>
        </div>

        <script>
            // Ultra-robust theme loading with multiple fallbacks
            function loadTheme(retryCount = 0) {
                const maxRetries = 3;
                const retryDelay = [50, 150, 300][retryCount] || 500;

                // Clear any existing theme state completely
                document.body.removeAttribute("data-theme");
                document.body.className = document.body.className
                    .split(" ")
                    .filter((cls) => !cls.startsWith("theme-"))
                    .join(" ");

                // Multiple theme loading strategies
                const loadStrategies = [
                    () => fetch("/sh-api/public/theme?" + Date.now()),
                    () => fetch("/sh-api/public/theme"),
                    () => Promise.resolve({ ok: false }), // Fallback to trigger default
                ];

                function attemptThemeLoad(strategyIndex = 0) {
                    if (strategyIndex >= loadStrategies.length) {
                        // All strategies failed, apply default theme
                        applyTheme(null, true);
                        return;
                    }

                    setTimeout(() => {
                        loadStrategies[strategyIndex]()
                            .then((res) => {
                                if (!res.ok)
                                    throw new Error(`HTTP ${res.status}`);
                                return res.json();
                            })
                            .then((data) => {
                                applyTheme(data.theme);
                            })
                            .catch((error) => {
                                console.warn(
                                    `Theme strategy ${strategyIndex + 1} failed:`,
                                    error,
                                );
                                attemptThemeLoad(strategyIndex + 1);
                            });
                    }, retryDelay);
                }

                function applyTheme(theme, isFailsafe = false) {
                    try {
                        if (theme && theme !== "default") {
                            document.body.setAttribute("data-theme", theme);
                            console.log(`Login theme applied: ${theme}`);
                        } else {
                            document.body.removeAttribute("data-theme");
                            console.log(
                                `Login default theme applied${isFailsafe ? " (failsafe)" : ""}`,
                            );
                        }

                        // Enhanced style refresh with multiple techniques
                        requestAnimationFrame(() => {
                            // Force reflow and repaint
                            document.body.offsetHeight;
                            document.body.style.opacity = "0.99";
                            document.body.offsetHeight;
                            document.body.style.opacity = "";

                            // Force CSS variable recalculation
                            const testDiv = document.createElement("div");
                            testDiv.style.cssText =
                                "position:absolute;visibility:hidden;color:var(--text);background:var(--bg);";
                            document.body.appendChild(testDiv);
                            const computedStyle =
                                window.getComputedStyle(testDiv);
                            computedStyle.color;
                            computedStyle.backgroundColor;
                            document.body.removeChild(testDiv);

                            // Verify theme application
                            setTimeout(() => {
                                const bgColor = window.getComputedStyle(
                                    document.body,
                                ).backgroundColor;
                                if (
                                    bgColor === "rgba(0, 0, 0, 0)" ||
                                    bgColor === "transparent"
                                ) {
                                    if (retryCount < maxRetries) {
                                        console.warn(
                                            `Theme verification failed, retry ${retryCount + 1}/${maxRetries}`,
                                        );
                                        loadTheme(retryCount + 1);
                                    }
                                }
                            }, 100);
                        });
                    } catch (error) {
                        console.error("Theme application error:", error);
                        if (retryCount < maxRetries) {
                            setTimeout(() => loadTheme(retryCount + 1), 200);
                        }
                    }
                }

                attemptThemeLoad();
            }

            // Multiple theme loading triggers for maximum reliability
            let themeLoaded = false;

            function safeLoadTheme() {
                if (themeLoaded) return;
                themeLoaded = true;
                loadTheme();
            }

            // Immediate load if DOM is ready
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", safeLoadTheme);
            } else {
                safeLoadTheme();
            }

            // Backup load after window load
            window.addEventListener("load", () => {
                setTimeout(() => {
                    if (!themeLoaded) {
                        themeLoaded = true;
                        loadTheme();
                    }
                }, 50);
            });

            // Final fallback after extended delay
            setTimeout(() => {
                if (!themeLoaded) {
                    console.warn("Theme loading timeout, applying fallback");
                    themeLoaded = true;
                    loadTheme();
                }
            }, 2000);

            const KEY = "socialhunt_token";
            let captchaEnabled = false;

            // Redirect if already logged in
            if (localStorage.getItem(KEY)) {
                window.location.replace("/");
            }

            // Load hCaptcha config and inject widget if enabled
            fetch("/sh-api/public/captcha-config")
                .then((r) => r.json())
                .then((cfg) => {
                    if (!cfg.enabled) return;
                    captchaEnabled = true;
                    const script = document.createElement("script");
                    script.src = "https://js.hcaptcha.com/1/api.js";
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                    const container = document.getElementById("captchaContainer");
                    const widget = document.getElementById("hcaptchaWidget");
                    container.style.display = "block";
                    widget.setAttribute("data-sitekey", cfg.site_key);
                })
                .catch(() => {});

            document.getElementById("loginForm").onsubmit = async (e) => {
                e.preventDefault();
                const token = document.getElementById("token").value.trim();
                const msg = document.getElementById("errorMsg");
                const btn = e.target.querySelector("button");

                msg.style.display = "none";
                if (!token) return;

                btn.disabled = true;
                btn.textContent = "Verifying...";

                const hcaptchaToken =
                    window.hcaptcha && captchaEnabled
                        ? hcaptcha.getResponse()
                        : "";

                try {
                    const res = await fetch("/sh-api/auth/verify", {
                        method: "POST",
                        headers: {
                            "X-Plugin-Token": token,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ hcaptcha_token: hcaptchaToken }),
                    });

                    if (res.ok) {
                        localStorage.setItem(KEY, token);
                        window.location.replace("/");
                        return;
                    }

                    const data = await res.json().catch(() => ({}));
                    if (res.status === 429) {
                        msg.textContent =
                            data.detail ||
                            "Too many failed attempts. Try again later.";
                    } else if (res.status === 400) {
                        msg.textContent =
                            "CAPTCHA verification failed. Please try again.";
                        if (window.hcaptcha) hcaptcha.reset();
                    } else {
                        msg.textContent = data.detail || "Invalid token";
                        if (window.hcaptcha) hcaptcha.reset();
                    }
                    msg.style.display = "block";
                    btn.disabled = false;
                    btn.textContent = "Sign in";
                } catch (err) {
                    msg.textContent = "Connection error";
                    msg.style.display = "block";
                    btn.disabled = false;
                    btn.textContent = "Sign in";
                }
            };
        </script>
    </body>
</html>
